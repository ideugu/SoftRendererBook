#include "Precompiled.h"
using namespace CK::DDD;

bool Transform::RemoveFromParent()
{
	if (!HasParent())
	{
		return true;
	}

	Transform& parent = *GetParentPtr();
	auto it = std::find(parent.ChildBegin(), parent.ChildEnd(), this);
	if (it != parent.ChildEnd())
	{
		// 오류 발생.
		return false;
	}

	// 부모 트랜스폼에서 자식 정보를 제거
	parent.GetChildren().erase(it);

	// 자신에게서 부모 정보를 제거
	_ParentPtr = nullptr;
	return true;
}

bool Transform::SetRoot()
{
	if (!RemoveFromParent())
	{
		return false;
	}

	// 로컬 정보를 월드 정보로 변경
	UpdateLocal();
	return true;
}

FORCEINLINE Transform& Transform::GetRoot()
{
	Transform* parent = nullptr;
	Transform* current = this;
	while ((parent = current->GetParentPtr()) != nullptr)
	{
		current = parent;
	}

	return *current;
}

bool Transform::SetParent(Transform& InTransform)
{
	// 현재 노드를 부모로부터 분리 ( 월드 = 로컬 )
	if (!SetRoot())
	{
		return false;
	}

	// 새로운 부모의 자식으로 등록. 이미 있는 경우에는 문제가 있는 상황.
	auto it = std::find(InTransform.ChildBegin(), InTransform.ChildEnd(), this);
	if (it != InTransform.ChildEnd())
	{
		return false;
	}

	// 새로운 트랜스폼 노드로 부모 재설정
	InTransform.GetChildren().emplace_back(this);
	_ParentPtr = &InTransform;
	Transform& newParent = *_ParentPtr;

	// 자신의 로컬과 모든 자식의 월드를 업데이트한다.
	UpdateLocal();

	return true;
}

// 월드 정보, 혹은 부모가 변경되면 이를 기반으로 로컬 정보를 변경
void Transform::UpdateLocal()
{
	if (HasParent())
	{
		const Transform& parent = *GetParentPtr();
		_LocalTransform = _WorldTransform.WorldToLocal(parent.GetWorldTransform());
	}
	else
	{
		_LocalTransform = _WorldTransform;
	}

	// 월드 정보 변경 시 자식의 월드 정보도 업데이트 ( 로컬 정보는 변함 없음. )
	UpdateChildrenWorld();
}

// 로컬 정보가 업데이트 되어서 월드 정보만 다시 계산
void Transform::UpdateWorld()
{
	// 자신의 월드 정보 업데이트
	if (HasParent())
	{
		const Transform& parent = *GetParentPtr();
		_WorldTransform = _LocalTransform.LocalToWorld(parent.GetWorldTransform());
	}
	else
	{
		_WorldTransform = _LocalTransform;
	}

	// 월드 정보 변경 시 자식의 월드 정보도 업데이트 ( 로컬 정보는 변함 없음. )
	UpdateChildrenWorld();
}

void Transform::UpdateChildrenWorld()
{
	for (auto it = ChildBegin(); it != ChildEnd(); ++it)
	{
		(*it)->UpdateWorld();
	}
}

